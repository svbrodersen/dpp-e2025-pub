\section{Flattening Rule for Scatter inside Map}
Let $Sx$ and $Si$ denote the shape of the inner arrays of $xss$ and $iss$ same as $S^1_{arr}$ in
the slides, let $Dx$ denote the flat data of $xss$, let $Di$ denote the flat
data of is and $Dv$ be the flat data of vss. Then we would have the following
flattening rules for the scatter inside a map:
\begin{lstlisting}
  let (Bx, _) = mkFlagArray Sx 0 (iota (length Sx))
  let (Bi, flags') = mkFlagArray Si (iota (length Si))
  let flags = map bool.u32 flags'
  let ii1s = sgmScan (+) 0 flags flags'
  let glob_idxs = map2 (\sgm ind -> ind + Bx[sgm]) ii1s Di
  in res = scatter Dx glob_idxs Dv
\end{lstlisting}

Bx[i] tells us the starting location of the inner list i in Dx. We then find
the segment indices for the iss, such that we can add the offset, Bx[sgm], to
each of the inner lists of iss. This then gives us the final global index of
each of the values. This then means we can directly scatter into Dx with the
global indices and given each index corresponds to some value in vss, we don't
have to change anything to Dv.

